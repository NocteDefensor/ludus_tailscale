# roles/tailscale_manage/tasks/uninstall.yaml
- name: Get device ID on Windows
  win_shell: |
    $status = & '{{ ansible_env.ProgramFiles }}\\Tailscale\\tailscale.exe' status --json | ConvertFrom-Json
    $status.Self.ID
  register: tailscale_status_windows
  ignore_errors: yes
  when: ansible_os_family == 'Windows'

- name: Get device ID on Linux
  ansible.builtin.shell: |
    tailscale status --json | python3 -c "import sys, json; print(json.load(sys.stdin)['Self']['ID'])"
  register: tailscale_status_linux
  ignore_errors: yes
  when: ansible_os_family != 'Windows'

- name: Set device ID fact
  set_fact:
    tailscale_device_id: "{{ tailscale_status_windows.stdout | default(tailscale_status_linux.stdout, true) }}"
  when: tailscale_status_windows is success or tailscale_status_linux is success

- name: Uninstall Tailscale on Windows
  block:
    - name: Set Windows-specific variables for uninstall
      set_fact:
        program_files_dir: "{{ ansible_env.ProgramFiles if (ansible_architecture in ['x86_64', 'amd64'] or ansible_env.PROCESSOR_ARCHITECTURE == 'AMD64') else ansible_env.ProgramFiles(x86) | default(ansible_env.ProgramFiles) }}"

    - name: Uninstall Tailscale
      win_package:
        path: '{{ program_files_dir }}\\Tailscale\\tailscale-setup.msi'
        state: absent

    - name: Remove Tailscale directory
      win_file:
        path: '{{ program_files_dir }}\\Tailscale'
        state: absent

    - name: Remove Tailscale data directory
      win_file:
        path: '{{ ansible_env.ProgramData }}\\Tailscale'
        state: absent
  when: ansible_os_family == "Windows"

- name: Uninstall Tailscale on Linux
  block:
    - name: Remove Tailscale package Fedora
      become: true
      ansible.builtin.dnf:
        name: "tailscale"
        state: absent
      timeout: 60
      ignore_errors: yes
      when: ansible_distribution == 'Fedora' or (ansible_distribution == 'Amazon' and ansible_distribution_major_version | int >= 2023)

    - name: Check if Tailscale is still installed on Fedora
      become: true
      ansible.builtin.dnf:
        name: "tailscale"
        state: absent
      register: tailscale_fedora_check
      check_mode: true
      when: ansible_distribution == 'Fedora' or (ansible_distribution == 'Amazon' and ansible_distribution_major_version | int >= 2023)

    - name: Warn user if Tailscale is still installed on Fedora
      ansible.builtin.debug:
        msg: "Tailscale is still installed on Fedora. Please uninstall it manually."
      when: tailscale_fedora_check is changed

    - name: Remove tailscale package Debian family
      become: true
      ansible.builtin.apt:
        name: "tailscale"
        state: absent
      timeout: 60
      ignore_errors: yes
      when: ansible_distribution in ['Debian', 'Ubuntu', 'Pop!_OS', 'OSMC']

    - name: Check if Tailscale is still installed on Debian family
      become: true
      ansible.builtin.apt:
        name: "tailscale"
        state: absent
      register: tailscale_debian_check
      check_mode: true
      when: ansible_distribution in ['Debian', 'Ubuntu', 'Pop!_OS', 'OSMC']

    - name: Warn user if Tailscale is still installed on Debian family
      ansible.builtin.debug:
        msg: "Tailscale is still installed on Debian. Please uninstall it manually."
      when: tailscale_debian_check is changed

    - name: Remove Tailscale package Arch family
      become: true
      ansible.builtin.pacman:
        name: "tailscale"
        state: absent
      timeout: 60
      ignore_errors: yes
      when: ansible_distribution == 'Archlinux'

    - name: Check if Tailscale is still installed on Arch family
      become: true
      ansible.builtin.pacman:
        name: "tailscale"
        state: absent
      register: tailscale_arch_check
      check_mode: true
      when: ansible_distribution == 'Archlinux'

    - name: Warn user if Tailscale is still installed on Arch family
      ansible.builtin.debug:
        msg: "Tailscale is still installed on Archlinux. Please uninstall it manually."
      when: tailscale_arch_check is changed

    - name: Remove Tailscale package openSUSE family
      become: true
      ansible.builtin.zypper:
        name: "tailscale"
        state: absent
      timeout: 60
      ignore_errors: yes
      when: ansible_distribution in ['openSUSE Leap', 'openSUSE Tumbleweed']

    - name: Check if Tailscale is still installed on openSUSE family
      become: true
      ansible.builtin.zypper:
        name: "tailscale"
        state: absent
      register: tailscale_suse_check
      check_mode: true
      when: ansible_distribution in ['openSUSE Leap', 'openSUSE Tumbleweed']

    - name: Warn user if Tailscale is still installed on openSUSE family
      ansible.builtin.debug:
        msg: "Tailscale is still installed on openSUSE. Please uninstall it manually."
      when: tailscale_suse_check is changed

    - name: Remove Tailscale package CentOS family
      become: true
      ansible.builtin.yum:
        name: "tailscale"
        state: absent
      timeout: 60
      ignore_errors: yes
      when: ansible_distribution in ['CentOS', 'RedHat', 'Rocky', 'AlmaLinux', 'OracleLinux']

    - name: Check if Tailscale is still installed on CentOS family
      become: true
      ansible.builtin.yum:
        name: "tailscale"
        state: absent
      register: tailscale_centos_check
      check_mode: true
      when: ansible_distribution in ['CentOS', 'RedHat', 'Rocky', 'AlmaLinux', 'OracleLinux']

    - name: Warn user if Tailscale is still installed on CentOS family
      ansible.builtin.debug:
        msg: "Tailscale is still installed on CentOS. Please uninstall it manually."
      when: tailscale_centos_check is changed

    - name: Remove Tailscale data directory
      ansible.builtin.file:
        path: /var/lib/tailscale
        state: absent
      become: yes

    - name: Remove Tailscale configuration
      ansible.builtin.file:
        path: /etc/tailscale
        state: absent
      become: yes
  when: ansible_os_family != "Windows"

- name: Remove device from tailnet
  uri:
    url: "https://api.tailscale.com/api/v2/device/{{ tailscale_device_id }}"
    method: DELETE
    headers:
      Authorization: "Bearer {{ tailscale_api_key }}"
  delegate_to: localhost
  register: result

- name: Debug the result
  debug:
    var: result